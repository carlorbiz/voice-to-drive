<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Hands-free voice recording with automatic Google Drive sync">
    
    <title>Voice to Drive</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="icons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="icons/favicon.svg" />
    <link rel="shortcut icon" href="icons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Voice2Drive" />
    
    <!-- Fonts: JetBrains Mono for that utilitarian feel, Plus Jakarta Sans for warmth -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app">
        <!-- Setup Screen (shown first time or when no mic permission) -->
        <section id="setup-screen" class="screen" aria-label="Setup">
            <div class="setup-container">
                <div class="logo">
                    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="2"/>
                        <path d="M24 14v10l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="24" cy="24" r="3" fill="currentColor"/>
                    </svg>
                </div>
                <h1>Voice to Drive</h1>
                <p class="tagline">Record your thoughts. Hands-free.</p>
                
                <div class="setup-steps">
                    <!-- Step 1: Microphone Selection -->
                    <div class="setup-step" id="step-mic">
                        <h2>Select Microphone</h2>
                        <p>Choose which microphone to use for recording</p>
                        <select id="mic-select" aria-label="Microphone selection">
                            <option value="">Loading devices...</option>
                        </select>
                        <button id="btn-test-mic" class="btn-secondary" disabled>
                            Test Microphone
                        </button>
                        <div id="mic-test-result" class="test-result" aria-live="polite"></div>
                    </div>
                    
                    <!-- Step 2: Google Drive Connection -->
                    <div class="setup-step" id="step-drive">
                        <h2>Connect Google Drive</h2>
                        <p>Your recordings will sync to your Drive automatically</p>
                        <button id="btn-connect-drive" class="btn-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                            Connect to Google Drive
                        </button>
                        <div id="drive-status" class="connection-status" aria-live="polite"></div>
                    </div>
                    
                    <!-- Ready to go -->
                    <div class="setup-step" id="step-ready">
                        <button id="btn-start-app" class="btn-primary btn-large" disabled>
                            Get Started
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Main Recording Screen -->
        <section id="main-screen" class="screen hidden" aria-label="Recording">
            <header class="main-header">
                <div class="status-bar">
                    <div class="connection-indicator" id="connection-status" title="Connection status">
                        <span class="dot"></span>
                        <span class="label">Online</span>
                    </div>
                    <div class="sync-indicator" id="sync-status" title="Sync status">
                        <span class="count">0</span>
                        <span class="label">pending</span>
                    </div>
                    <button id="btn-settings" class="btn-icon" aria-label="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                        </svg>
                    </button>
                </div>
            </header>
            
            <main class="recording-area">
                <!-- Timer Display -->
                <div class="timer-display" id="timer">
                    <span class="hours">00</span>
                    <span class="separator">:</span>
                    <span class="minutes">00</span>
                    <span class="separator">:</span>
                    <span class="seconds">00</span>
                </div>
                
                <!-- Status Message -->
                <div class="status-message" id="status-message">
                    Ready to record
                </div>
                
                <!-- Audio Visualiser -->
                <div class="visualiser-container">
                    <div class="visualiser" id="visualiser" aria-label="Audio level">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                </div>
                
                <!-- Main Record Button -->
                <div class="control-area">
                    <button id="btn-record" class="btn-record" aria-label="Start recording">
                        <span class="record-icon"></span>
                    </button>
                    <p class="control-hint" id="control-hint">Tap to start recording</p>
                </div>
                
                <!-- Secondary Controls (visible when recording) -->
                <div class="secondary-controls hidden" id="secondary-controls">
                    <button id="btn-pause" class="btn-control" aria-label="Pause recording">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                        <span>Pause</span>
                    </button>
                    <button id="btn-stop" class="btn-control btn-stop" aria-label="Stop and save">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="4" y="4" width="16" height="16" rx="2"/>
                        </svg>
                        <span>Stop & Save</span>
                    </button>
                    <button id="btn-cancel" class="btn-control btn-cancel" aria-label="Cancel recording">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        <span>Cancel</span>
                    </button>
                </div>
            </main>
            
            <!-- Recordings List (collapsible) -->
            <aside class="recordings-panel" id="recordings-panel">
                <button class="panel-toggle" id="btn-toggle-recordings" aria-expanded="false">
                    <span>Recent Recordings</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>
                <div class="recordings-list" id="recordings-list" hidden>
                    <!-- Populated dynamically -->
                </div>
            </aside>
        </section>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden" role="dialog" aria-labelledby="settings-title">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <header class="modal-header">
                    <h2 id="settings-title">Settings</h2>
                    <button id="btn-close-settings" class="btn-icon" aria-label="Close settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </header>
                <div class="modal-body">
                    <div class="setting-group">
                        <label for="settings-mic">Microphone</label>
                        <select id="settings-mic"></select>
                    </div>
                    <div class="setting-group">
                        <label for="settings-quality">Audio Quality</label>
                        <select id="settings-quality">
                            <option value="64000">Standard (64 kbps)</option>
                            <option value="128000">High (128 kbps)</option>
                            <option value="192000">Maximum (192 kbps)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="settings-autosave" checked>
                            Auto-save every 30 seconds
                        </label>
                        <p class="setting-hint">Protects against data loss if app crashes</p>
                    </div>
                    <div class="setting-group">
                        <label>Google Drive</label>
                        <div id="settings-drive-info" class="drive-info"></div>
                        <button id="btn-disconnect-drive" class="btn-secondary btn-small">
                            Disconnect
                        </button>
                    </div>
                    <div class="setting-group">
                        <label>Storage</label>
                        <div id="storage-info" class="storage-info">
                            <div class="storage-bar">
                                <div class="storage-used" style="width: 0%"></div>
                            </div>
                            <p class="storage-text">Calculating...</p>
                        </div>
                        <button id="btn-clear-synced" class="btn-secondary btn-small">
                            Clear Synced Recordings
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container" aria-live="polite"></div>
    </div>
    
    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/recorder.js"></script>
    <script src="js/drive.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/transcribe.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js" defer></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
<!-- CloudFlare deployment trigger -->

    <script src="js/supabase.js"></script>
